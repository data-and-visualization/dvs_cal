---
title: "Create CSV file of Future Workshop"
subtitle: "Data are from the LibCal API, parsed by rvest and dplyr"
date: "`r Sys.Date()`"
output: html_notebook
---

The is the RMD to Joel's rvestLibcalCode.R

Undertook this revision because the integratin of online and in-person workshops made Joel's script ineffective.  Nonetheless, borrowed heavily from his previous work.

```{r}
Sys.setenv(TZ="America/New_York")
library(rvest)
# library(lubridate)
library(clock)
library(tidyverse)
library(fs)
```

Import LibCal API list of future workshops.

```{r}
dvs_cal <- read_html("https://api3.libcal.com/api_events.php?iid=971&m=upc&cid=3819&c=&d=25858&l=50&target=_blank")
```

## Wrangle data

```{r}
nregistration <- html_nodes(dvs_cal, ".s-lc-ea-treg a")
registration_list <- html_attr(nregistration, "href")
```

Convert rvest response into a tibble by parsing the HTML table.

```{r}
by_workshop <- html_nodes(dvs_cal, ".cat25858") %>% 
    html_table()
```

Data come back in long tidy format.  Convert to wide.  lines 46 and 47 (ish) take into account that the API delivers inconsistent information based on workshop type.  i.e. online workshops report less data than in-person workshops

```{r}
my_df <- tibble(by_workshop) %>% 
    tidyr::unnest(cols = everything()) %>% 
    mutate(X1 = if_else(X2 == "n/a", "Location:", X1)) %>%      # this line
    mutate(X2 = if_else(X2 == "n/a", "Online", X2)) %>%         # this line
    tidyr::pivot_wider(names_from = X1, values_from = X2, values_fn = list) %>%   # `values_fn = list` suppresses warnings
    janitor::clean_names() %>% 
    select(-c("campus", "categories")) %>% 
    unnest(cols = everything())
```


Insert workshop URL into the data frame

```{r}
my_df$registration <- registration_list
```

Transform the data to look just like the original from Joel.

```
{r}
my_df <- my_df %>% 
    rename(date_orig = date) %>% 
    mutate(workshop_id = str_extract(registration, "(?<=event/)\\d+")) %>% 
    mutate(date = clock::date_parse(date_orig, format = "%A, %B %d, %Y")) %>% 
    mutate(workshop_begins = str_split(time, " - ", n = 2, simplify = TRUE)[,1]) %>% 
    mutate(workshop_begins = glue::glue("{date} {workshop_begins}")) %>% 
    mutate(workshop_begins = ymd_hm(workshop_begins, tz = "America/New_York")) %>% 
    mutate(workshop_ends = str_split(time, " - ", n = 2, simplify = TRUE)[,2]) %>% 
    mutate(workshop_ends = glue::glue("{date} {workshop_ends}")) %>% 
    mutate(workshop_ends = ymd_hm(workshop_ends, tz = "America/New_York")) %>% 
    mutate(workshop_duration_minutes = (as.numeric(workshop_ends - workshop_begins) * 60)) %>% 
    mutate(description = str_extract(description, ".*(?<=\\.)")) %>%            # take only the first paragraph
    mutate(registration_link = str_extract(registration, ".*(?=\\?)")) %>% 
    select(workshop_id, date, title, presenter, workshop_duration_minutes, 
             workshop_begins, workshop_ends, description, registration_link,
             location) 
my_df
```


```{r}
ty_df <- my_df
foo <- ty_df %>% 
    mutate(workshop_id = str_extract(registration, "(?<=event/)\\d+")) %>% 
    mutate(workshop_begins = date_time_parse(glue::glue("{date} {str_extract(time, '.*[ap]m(?= - )')}"),
                                             "America/New_York",
                                             format = "%a, %b %d, %Y %I:%M%p")) %>%
    mutate(begins_display = date_format(workshop_begins, format = "%I:%M %p")) %>% 
    mutate(workshop_ends = date_time_parse(glue::glue("{date} {str_extract(time, '(?<= - ).*[ap]m')}"),
                                           "America/New_York",
                                           format = "%a, %b %d, %Y %I:%M%p")) %>% 
    mutate(ends_display = date_format(workshop_ends, format = "%r")) %>% 
    mutate(workshop_duration_minutes = as.numeric(workshop_ends - workshop_begins) * 60) %>% 
    mutate(description = str_extract(description, ".*(?<=\\.)")) %>%            # take only the first paragraph
    mutate(registration_link = str_extract(registration, ".*(?=\\?)")) %>% 
    mutate(date = date_format(workshop_begins, format = "%F")) %>%
    mutate(day = date_format(workshop_begins, format = "%a")) %>% 
    select(workshop_id, date, day, title, presenter, workshop_duration_minutes, 
           begins_display, ends_display, description, registration_link, location) 
foo

# googlesheets4::gs4_create("foo Master Workshop list for Semester",
#                           sheets = list(Sheet1 = foo),
#                           timeZone = "America/New_York")
```


## Write output

Manually move, and rename, the google sheet into the proper CDVS google drive space.

```{r}
fs::dir_create("output")

fs::file_copy("output/workshops.csv",
              paste("output/workshops.bak", Sys.Date(), Sys.getpid(), "csv", sep = "." ))

write_csv(my_df, "output/workshops.csv")
```

Write to Google Sheets.  MANUALLY click the green arrow.

```{r eval=FALSE, include=FALSE}
googlesheets4::gs4_create("Master Workshop list for Semester", sheets = list(sname = my_df))
```

