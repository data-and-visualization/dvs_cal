---
title: "Create CSV file of Future Workshops"
subtitle: "Data are from the LibCal API, parsed by rvest and dplyr"
date: "`r Sys.Date()`"
---

1. Run this at the beginning of the semester to generate the main workshop list
1. Use this to generate the workshop flyer, for advertising
1. This script depends on `01_gather_and_wrangle.R` to harvest the data

## Release Notes

- August 10, 2021:  Undertook this revision because the integration of online and in-person workshops made Joel's script ineffective.  Nonetheless, borrowed heavily from his previous work.  The RMD migration of Joel's `rvestLibcalCode.R`

## library packages

```{r message=FALSE, warning=FALSE}
Sys.setenv(TZ="America/New_York")
library(fs)
library(tidyverse)
library(lubridate)
```

## Get Data

Ingest data from web page (LibCal API) & make a column headers template for the attendance sheets that will be written to Google.

### harvest webpage data from LibCal API

this next CODE CHUNK is DISABLED, but designed to rerun the harvest script


```{r get wrangled data, include=FALSE}
source("01_gather_and_wrangle.R", local = knitr::knit_global())
# or sys.source("your-script.R", envir = knitr::knit_global())
```

## Wrangle Data

```{r}
for_goog_flyer_df <- my_df %>%
    # select(workshop_begins, where(is.character)) |> 
    mutate(my_day = lubridate::wday(workshop_begins, label = TRUE, abbr = FALSE)) |> 
    relocate(my_day) |> 
    mutate(date_time = str_c(my_day, day_flyer, time, sep = " ")) |> 
    mutate(date_time = str_remove(date_time, " \\w{3}(?=,)")) |> 
    mutate(online_in_person_flyer     = str_glue("[{online_in_person_flyer    }]")) |> 
    mutate(description = str_trim(str_remove_all(description, "\\[(Online|In-person)\\]"))) |> 
    select(workshop_id, `Date(time)` = date_time, title, presenter,  format = online_in_person_flyer, registration_link, abstract = description) 
```


## Write output

Manually move, and rename, the google sheet into the proper CDVS google drive space.

```{r}
fs::dir_create("output")

fs::file_copy("output/workshops.csv", 
              glue::glue("output/workshops.bak.{Sys.Date()}.{round(Sys.getpid() * runif(1))}.csv"))

write_csv(my_df, "output/workshops.csv")

write_csv(for_goog_flyer_df, "output/forgoog_flyer.csv")  
```

## For Flyer -- Upload manully to Google Sheets.  

```{r eval=FALSE, include=FALSE}
# googlesheets4::gs4_create("Main Workshop list for Semester", sheets = list(sname = my_df))

googlesheets4::gs4_create("Main Workshop list for Semester",
                          sheets = list(Sheet1 = for_goog_flyer_df),
                          timeZone = "America/New_York")
```

## Next steps

See "Manually upload"

### above chunk 

may have to be be run manually.  It will upload to your google drive home directory (Check "recent" on google drive).  Then move to the proper spot.  **BE SURE TO CHECK THE DATES**.  Google drive has a tendency to fock up the dates and impose GMT instead of EST!!   I noticed this when mnaully uploading.  See next...


### Manually upload 

1. `for_googflyer.csv` to:  `Google Drive > CDVS > Services > Workshops > [2021 Fall] > Planning`
2. Then open the output/workshops.csv ; paste to notepad++ ; paste into columns A, B, and C of the `DVS_Workshops_summary_stats` file in Google Drive: from GD > CDVS > Workshops > _Assessment > longitudinal

AND RENAME the google sheet - "DO NOT MODIFY"


#### Note  
By spring of 2022 this problem had resolved but in the fall of 2021 there were extraneous leading single apostrophes showing up in the uploaded data.  This was probably a bug with `library(googlesheets4)`. The manual work-around, instead of `gs4_create()`, was to upload the forgoog_flyer.csv file **manually** to Google Drive, then open the csv on Google Drive, and then "Open With" as a Sheet.  BUT, this allowed Google to force it's own GMT timezone.  So, you have to opea blank sheet (sheets.new), Then `import`, then be sure not to allow any automatic conversion of fields (this is an option in the later stages of the import.)
